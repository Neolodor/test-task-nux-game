services:
  base:
    image: app-base:latest
    build:
      context: ./docker/base
      args:
        APP_USER: app_user
        APP_GROUP: app
        APP_UID: 2000
        APP_GID: 2000

  php:
    build:
      context: ./docker/php
      args:
        BASE_IMAGE: app-base:latest
    depends_on:
      - base
    container_name: app-php
    working_dir: /app
    environment:
      TZ: UTC
    volumes:
      - ./:/app:cached
      - ./docker/php/php.ini:/etc/php/8.2/fpm/conf.d/99-app.ini:ro
      - php_sock:/run/php
    networks:
      appnet:
        ipv4_address: 172.30.1.10

  nginx:
    build:
      context: ./docker/nginx
      args:
        BASE_IMAGE: app-base:latest
    depends_on:
      - base
      - php
    container_name: app-nginx
    environment:
      TZ: UTC
    ports:
      - "80:80"
    volumes:
      - ./:/app:cached
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - php_sock:/run/php
    networks:
      appnet:
        ipv4_address: 172.30.1.11

  postgres:
    image: postgres:18
    container_name: app-postgres
    environment:
      TZ: UTC
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      appnet:
        ipv4_address: 172.30.1.12

  redis:
    image: redis:8
    container_name: app-redis
    environment:
      TZ: UTC
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
    networks:
      appnet:
        ipv4_address: 172.30.1.13

networks:
  appnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.1.0/24

volumes:
  postgres_data:
  redis_data:
  php_sock:
